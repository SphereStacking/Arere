---
title: 一般的なパターン
description: GitHub ActionsでArereを使う際の一般的なパターン
---

# 一般的なパターン

## 環境変数

GitHubシークレットを環境変数としてアクセス：

```typescript
export default defineAction({
  name: 'deploy',
  async run({ env, tui }) {
    const apiKey = env.API_KEY
    const deployUrl = env.DEPLOY_URL

    if (!apiKey) {
      throw new Error('API_KEYシークレットが必要です')
    }

    tui.output.info(`${deployUrl}にデプロイ中`)
  }
})
```

```yaml
- uses: ./actions/arere-action
  with:
    action: deploy
  env:
    API_KEY: ${{ secrets.API_KEY }}
    DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
```

## 多段階パイプライン

```typescript
// .arere/actions/ci-pipeline.ts
export default defineAction({
  name: 'ci-pipeline',
  description: '完全なCIパイプライン',
  async run({ $, tui }) {
    tui.output.section('ステージ1: Linting')
    await $`npm run lint`

    tui.output.section('ステージ2: 型チェック')
    await $`npm run typecheck`

    tui.output.section('ステージ3: テスト')
    const testResult = await $`npm test`
    if (testResult.exitCode !== 0) {
      throw new Error('テストが失敗しました')
    }

    tui.output.section('ステージ4: ビルド')
    await $`npm run build`

    tui.output.success('すべてのステージが成功しました！')
  }
})
```

## エラーハンドリングとロールバック

```typescript
export default defineAction({
  name: 'deploy-with-rollback',
  async run({ $, tui }) {
    try {
      tui.output.section('デプロイ中')
      await $`npm run deploy`

      tui.output.section('ヘルスチェック')
      const health = await $`curl https://example.com/health`

      if (!health.stdout.includes('OK')) {
        throw new Error('ヘルスチェックが失敗しました')
      }

      tui.output.success('デプロイ成功')
    } catch (error) {
      tui.output.error('デプロイ失敗、ロールバック中')
      await $`npm run rollback`
      throw error
    }
  }
})
```

---

## ベストプラクティス

### 1. アクションを焦点を絞って保つ

各アクションは1つのことをうまく行うべきです：

✅ 良い例:
- `test.ts` - テストを実行
- `build.ts` - プロジェクトをビルド
- `deploy.ts` - サーバーにデプロイ

❌ 悪い例:
- `do-everything.ts` - テスト、ビルド、デプロイ、通知など

### 2. 設定に環境変数を使用

```typescript
// ❌ 悪い例
const apiUrl = 'https://api.example.com'

// ✅ 良い例
const apiUrl = env.API_URL || 'https://api.example.com'
```

### 3. 意味のある出力を提供

```typescript
tui.output.section('デプロイ中')    // 主要なセクション
tui.output.step(1, 'ビルド中')     // 連続したステップ
tui.output.info('...')            // 情報
tui.output.success('完了！')       // 成功
tui.output.error('失敗！')         // エラー
```

### 4. エラーを適切に処理

```typescript
const result = await $`npm test`
if (result.exitCode !== 0) {
  tui.output.error('テストが失敗しました')
  tui.output.code(result.stderr)
  throw new Error('テストスイートが失敗しました')
}
```

### 5. まずローカルでテスト

```bash
# アクションをテスト
arere run deploy

# CI環境をシミュレート
CI=true arere run deploy
```

---

## CIでのCLI引数

柔軟なCIワークフローのために引数をアクションに渡す：

```typescript
// .arere/actions/deploy.ts
export default defineAction({
  name: 'deploy',
  description: 'ターゲット環境にデプロイ',
  async run({ args, env, $, tui }) {
    const target = args[0] || env.DEPLOY_TARGET || 'staging'
    const dryRun = args.includes('--dry-run')

    if (dryRun) {
      tui.output.info(`[ドライラン] ${target}にデプロイ予定`)
      return
    }

    await $`npm run deploy -- --env ${target}`
    tui.output.success(`${target}にデプロイ完了！`)
  }
})
```

```yaml
# .github/workflows/deploy.yml
jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm ci
      - run: npx arere run deploy staging

  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm ci
      - run: npx arere run deploy production
```

### GitHubコンテキストからの動的な引数

```yaml
- run: npx arere run release ${{ github.ref_name }}
```

```typescript
export default defineAction({
  name: 'release',
  async run({ args, $ }) {
    const version = args[0]  // 例: gitタグから'v1.2.3'
    await $`npm publish --tag ${version}`
  }
})
```

---

## 次のステップ

- [高度な使用方法](./advanced) - アーティファクト、マトリックスビルド
