---
title: Plugin Config Schema API
description: Arereでプラグイン設定スキーマを定義・使用するためのAPIリファレンス
---

# プラグイン設定スキーマAPI

このドキュメントでは、Arereでプラグイン設定スキーマを定義および使用するためのAPIについて説明します。

## 概要

プラグインは[Zod](https://zod.dev/)を使用して設定スキーマを定義でき、以下を提供します：

- **型安全**: スキーマから推論されるTypeScript型
- **ランタイム検証**: ユーザー設定の自動検証
- **デフォルト値**: すべてのオプションの適切なデフォルト値
- **自動生成UI**: スキーマ定義から生成されるフォーム
- **エラーメッセージ**: 明確な検証エラーメッセージ

## 目次

- [基本的な使用方法](#基本的な使用方法)
- [スキーマ定義](#スキーマ定義)
- [サポートされるフィールドタイプ](#サポートされるフィールドタイプ)
- [設定へのアクセス](#設定へのアクセス)
- [設定ファイル形式](#設定ファイル形式)
- [型推論](#型推論)
- [検証](#検証)
- [ベストプラクティス](#ベストプラクティス)
- [完全な例](#完全な例)

## 基本的な使用方法

### 1. プラグインでスキーマを定義

```typescript
// src/index.ts
import { z } from 'zod'
import { definePlugin } from 'arere'

export const configSchema = z.object({
  apiKey: z.string()
    .default('')
    .describe('API認証キー'),

  timeout: z.number()
    .min(1000)
    .max(30000)
    .default(5000)
    .describe('ミリ秒単位のリクエストタイムアウト'),

  retries: z.number()
    .min(0)
    .max(5)
    .default(3)
    .describe('再試行回数'),

  verbose: z.boolean()
    .default(false)
    .describe('詳細ログを有効化'),
})

export type PluginConfig = z.infer<typeof configSchema>

export default definePlugin({
  meta: {
    name: 'arere-plugin-example',
    version: '1.0.0',
    description: '設定を持つサンプルプラグイン',
  },
  actions: ['./actions/example.ts'],
  configSchema,  // ← スキーマを含める
})
```

### 2. アクションで設定を使用

```typescript
// actions/example.ts
import { defineAction } from 'arere'
import type { PluginConfig } from '../src/index.js'

export default defineAction({
  name: 'example-action',
  description: 'プラグイン設定を使用',
  async run({ tui, pluginConfig }) {
    // 型安全な設定へのアクセス
    const config = pluginConfig as PluginConfig

    const apiKey = config.apiKey || 'default-key'
    const timeout = config.timeout || 5000
    const retries = config.retries || 3

    if (config.verbose) {
      tui.output.log(`タイムアウト: ${timeout}ms, 再試行: ${retries}`)
    }

    // 設定を使用...
  },
})
```

### 3. ユーザー設定

```json
// .arere/settings.json
{
  "plugins": {
    "arere-plugin-example": {
      "enabled": true,
      "config": {
        "apiKey": "sk-1234567890",
        "timeout": 10000,
        "retries": 5,
        "verbose": true
      }
    }
  }
}
```

## スキーマ定義

### ArerePluginインターフェース

```typescript
interface ArerePlugin {
  meta: {
    name: string
    version: string
    description?: string
    author?: string
  }
  actions: string[]
  localesPath?: string
  configSchema?: z.ZodObject<any>  // ← 設定スキーマ
}
```

### スキーマ要件

- `z.ZodObject`である必要がある（他のZod型は不可）
- すべてのフィールドに`.default()`値を設定すべき
- すべてのフィールドに`.describe()`説明を設定すべき
- フィールド名はcamelCaseにすべき
- 適切なバリデータを使用（`.min()`, `.max()`, `.email()`など）

## サポートされるフィールドタイプ

### 文字列

```typescript
z.string()
  .default('default-value')
  .describe('フィールドの説明')
  .min(1)                      // オプション: 最小長
  .max(100)                    // オプション: 最大長
  .email()                     // オプション: メール検証
  .url()                       // オプション: URL検証
```

**UI表現**: テキスト入力フィールド

### 数値

```typescript
z.number()
  .default(10)
  .describe('数値')
  .min(1)                      // オプション: 最小値
  .max(100)                    // オプション: 最大値
  .int()                       // オプション: 整数のみ
  .positive()                  // オプション: 正の数
```

**UI表現**: 検証付き数値入力フィールド

### ブール

```typescript
z.boolean()
  .default(false)
  .describe('機能を有効化/無効化')
```

**UI表現**: トグルスイッチ

### 列挙型

```typescript
z.enum(['option1', 'option2', 'option3'])
  .default('option1')
  .describe('オプションを選択')
```

**UI表現**: ラジオボタン選択

### オプションフィールド

```typescript
z.string().optional()         // フィールドはオプション
  .describe('オプション設定')
```

### ネストされたオブジェクト

```typescript
z.object({
  database: z.object({
    host: z.string().default('localhost'),
    port: z.number().default(5432),
  }).default({ host: 'localhost', port: 5432 }),
})
```

**注意**: ネストされたオブジェクトはサポートされていますが、UI生成は1レベルの深さに制限されています。

## 設定へのアクセス

### プラグインアクション内で

設定は実行コンテキストの`pluginConfig`フィールドを通じて渡されます：

```typescript
export default defineAction({
  name: 'my-action',
  description: 'My action',
  async run({ tui, pluginConfig }) {
    // 設定型にキャスト
    const config = pluginConfig as MyPluginConfig

    // フォールバック付きでアクセス
    const apiKey = config?.apiKey || 'default'
    const timeout = config?.timeout || 5000

    // 設定を使用...
  },
})
```

### 型安全

```typescript
// スキーマから型を定義
export type MyConfig = z.infer<typeof configSchema>

// アクションで使用
export default defineAction({
  name: 'typed-action',
  description: 'Action with typed config',
  async run({ pluginConfig }) {
    const config = pluginConfig as MyConfig

    // TypeScriptは型を認識！
    config.apiKey    // string
    config.timeout   // number
    config.verbose   // boolean
  },
})
```

## 設定ファイル形式

### シンプルな有効化/無効化

```json
{
  "plugins": {
    "plugin-name": true,   // デフォルトで有効化
    "another-plugin": false // 無効化
  }
}
```

### 設定付き

```json
{
  "plugins": {
    "plugin-name": {
      "enabled": true,
      "config": {
        "key1": "value1",
        "key2": 42,
        "key3": true
      }
    }
  }
}
```

### フィールドの省略（デフォルトを使用）

```json
{
  "plugins": {
    "plugin-name": {
      "enabled": true,
      "config": {
        "apiKey": "custom-key"
        // 他のすべてのフィールドはスキーマのデフォルトを使用
      }
    }
  }
}
```

## 型推論

Zodは自動型推論を提供します：

```typescript
export const configSchema = z.object({
  name: z.string().default(''),
  count: z.number().default(0),
  enabled: z.boolean().default(false),
})

// TypeScript型を推論
export type Config = z.infer<typeof configSchema>

// 以下と同等:
// type Config = {
//   name: string
//   count: number
//   enabled: boolean
// }
```

## 検証

### 自動検証

Arereはスキーマに対してユーザー設定を自動的に検証します：

```typescript
const configSchema = z.object({
  port: z.number().min(1000).max(65535),
  email: z.string().email(),
})

// 有効な設定
{ port: 3000, email: 'user@example.com' }  // ✅ 通過

// 無効な設定
{ port: 100, email: 'user@example.com' }   // ❌ ポートが低すぎる
{ port: 3000, email: 'invalid' }           // ❌ 無効なメール
{ email: 'user@example.com' }              // ❌ portが欠落
```

### カスタム検証

```typescript
const configSchema = z.object({
  password: z.string()
    .min(8, 'パスワードは8文字以上である必要があります')
    .regex(/[A-Z]/, 'パスワードは大文字を含む必要があります')
    .regex(/[0-9]/, 'パスワードは数字を含む必要があります'),
})
```

### 検証エラー

検証が失敗すると、Arereは明確なエラーメッセージを表示します：

```
Configuration Error: arere-plugin-example
- timeout: 数値は1000から30000の間である必要があります
- email: 無効なメールアドレスです
```

## ベストプラクティス

### 1. 常にデフォルトを提供

```typescript
// ✅ 良い例
z.string().default('sensible-default')

// ❌ 悪い例
z.string()  // デフォルトなし
```

### 2. 説明を追加

```typescript
// ✅ 良い例
z.boolean()
  .default(false)
  .describe('自動バックアップを有効化')

// ❌ 悪い例
z.boolean().default(false)  // 説明なし
```

### 3. 適切なバリデータを使用

```typescript
// ✅ 良い例
z.number()
  .min(1000)
  .max(30000)
  .default(5000)

// ❌ 悪い例
z.number().default(5000)  // 検証なし
```

### 4. 設定型をエクスポート

```typescript
// ✅ 良い例
export const configSchema = z.object({ /* ... */ })
export type PluginConfig = z.infer<typeof configSchema>

// ❌ 悪い例
const configSchema = z.object({ /* ... */ })  // エクスポートされていない
```

### 5. 欠落した設定を適切に処理

```typescript
// ✅ 良い例
async run({ pluginConfig }) {
  const config = pluginConfig as MyConfig
  const apiKey = config?.apiKey || 'fallback'
}

// ❌ 悪い例
async run({ pluginConfig }) {
  const apiKey = pluginConfig.apiKey  // undefinedの場合クラッシュする可能性
}
```

### 6. 設定オプションを文書化

README セクションに設定オプションの説明を含める：

```markdown
## 設定

- `apiKey` (string): API認証キー
- `timeout` (number): ミリ秒単位のリクエストタイムアウト (1000-30000)
- `retries` (number): 再試行回数 (0-5)
- `verbose` (boolean): 詳細ログを有効化
```

## 完全な例

### プラグイン定義

```typescript
// src/index.ts
import { z } from 'zod'
import { definePlugin } from 'arere'

export const configSchema = z.object({
  // 検証付き文字列フィールド
  apiKey: z.string()
    .min(1, 'APIキーは必須です')
    .default('')
    .describe('API認証キー'),

  // 範囲付き数値フィールド
  timeout: z.number()
    .min(1000, 'タイムアウトは最低1秒必要です')
    .max(30000, 'タイムアウトは最大30秒です')
    .default(5000)
    .describe('ミリ秒単位のリクエストタイムアウト'),

  // 列挙型フィールド
  environment: z.enum(['development', 'staging', 'production'])
    .default('development')
    .describe('デプロイ環境'),

  // ブールフィールド
  verbose: z.boolean()
    .default(false)
    .describe('詳細ログを有効化'),

  // オプションフィールド
  webhookUrl: z.string()
    .url('有効なURLである必要があります')
    .optional()
    .describe('オプションのWebhook通知URL'),

  // ネストされたオブジェクト
  database: z.object({
    host: z.string().default('localhost'),
    port: z.number().min(1).max(65535).default(5432),
    ssl: z.boolean().default(false),
  }).default({ host: 'localhost', port: 5432, ssl: false })
    .describe('データベース接続設定'),
})

export type DeployPluginConfig = z.infer<typeof configSchema>

export default definePlugin({
  meta: {
    name: 'arere-plugin-deploy',
    version: '1.0.0',
    description: 'デプロイ自動化プラグイン',
    author: 'Your Name',
  },
  actions: ['./actions/deploy.ts'],
  configSchema,
})
```

### 設定の使用

```typescript
// actions/deploy.ts
import { defineAction } from 'arere'
import type { DeployPluginConfig } from '../src/index.js'

export default defineAction({
  name: 'deploy',
  description: '環境にデプロイ',
  async run({ tui, pluginConfig }) {
    const config = pluginConfig as DeployPluginConfig

    // IntelliSense付きの型安全なアクセス
    const env = config.environment || 'development'
    const timeout = config.timeout || 5000

    if (config.verbose) {
      tui.output.log(`${env}にデプロイ中...`)
      tui.output.log(`タイムアウト: ${timeout}ms`)
    }

    // 設定を使用したデプロイロジック...

    if (config.webhookUrl) {
      // Webhook通知を送信
    }
  },
})
```

### ユーザー設定

```json
{
  "plugins": {
    "arere-plugin-deploy": {
      "enabled": true,
      "config": {
        "apiKey": "sk-prod-1234567890",
        "timeout": 15000,
        "environment": "production",
        "verbose": true,
        "webhookUrl": "https://hooks.slack.com/...",
        "database": {
          "host": "db.example.com",
          "port": 5432,
          "ssl": true
        }
      }
    }
  }
}
```

## 関連ドキュメント

- [プラグイン設定ガイド](/guides/plugins/config) - ユーザーガイド
- [プラグインの開発](/guides/plugins/creating) - プラグイン開発
- [Zodドキュメント](https://zod.dev/) - Zodスキーマ検証ライブラリ

## まとめ

プラグイン設定スキーマは以下を提供します：

✅ **型安全** - TypeScript推論付き
✅ **ランタイム検証** - 明確なエラーメッセージ付き
✅ **自動生成UI** - 簡単な設定用
✅ **適切なデフォルト** - ゼロ設定での動作
✅ **開発者フレンドリー** - ZodによるAPI

まずデフォルト値を持つシンプルなスキーマを定義し、必要に応じて検証と説明を追加してください。ユーザーはUIまたは`.arere/settings.json`の編集を通じてプラグインを設定できます。
