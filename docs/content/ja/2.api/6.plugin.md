---
title: Plugin API
description: プラグインシステムを使用してアクションをnpmパッケージとして配布・共有するためのAPIリファレンス
---

# Plugin API

プラグインシステムを使用して、アクションをnpmパッケージとして配布・共有できます。

## プラグインとは

プラグインは以下の特徴を持つnpmパッケージです：

- パッケージ名が `arere-plugin-` で始まる
- `package.json` の `keywords` に `arere-plugin` が含まれる
- アクションファイルを含む

## プラグインの作成

### 1. プロジェクト構造

```
arere-plugin-example/
├── package.json
├── src/
│   └── index.ts          # プラグイン定義
├── actions/
│   ├── action-1.ts       # アクション1
│   └── action-2.ts       # アクション2
├── tsup.config.ts        # ビルド設定
└── README.md
```

### 2. package.json

```json
{
  "name": "arere-plugin-example",
  "version": "1.0.0",
  "description": "Example plugin for arere",
  "keywords": ["arere-plugin"],
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "files": [
    "dist",
    "actions"
  ],
  "actions": {
    "build": "tsup",
    "prepublishOnly": "npm run build"
  },
  "peerDependencies": {
    "arere": ">=0.1.0"
  },
  "devDependencies": {
    "arere": "^0.1.0",
    "tsup": "^8.0.0",
    "typescript": "^5.0.0"
  }
}
```

### 3. プラグイン定義 (src/index.ts)

```typescript
import { definePlugin } from 'arere'

export default definePlugin({
  meta: {
    name: 'arere-plugin-example',
    version: '1.0.0',
    description: 'Example plugin',
    author: 'Your Name',
  },
  actions: [
    './actions/action-1.ts',
    './actions/action-2.ts',
  ],
})
```

### 4. アクション作成 (actions/action-1.ts)

```typescript
import { defineAction } from 'arere'

export default defineAction({
  name: 'example-action',
  description: 'Example action from plugin',
  category: 'example',
  async run({ tui }) {
    tui.output.log('Hello from plugin!')
  },
})
```

**i18n対応の場合**:

```typescript
import { defineAction } from 'arere'

export default defineAction({
  name: 'example-action',
  description: ({ t }) => t('actions.example.description', { ns: 'example-plugin' }),
  category: 'example',
  async run({ tui, t }) {
    const greeting = t('greeting', { ns: 'example-plugin' })
    tui.output.log(greeting)
  },
})
```

### 5. ビルド設定 (tsup.config.ts)

```typescript
import { defineConfig } from 'tsup'

export default defineConfig({
  entry: ['src/index.ts'],
  format: ['esm'],
  dts: true,
  clean: true,
  outDir: 'dist',
})
```

## プラグインのインストール

### グローバルインストール

```bash
npm install -g arere-plugin-example
```

### プロジェクトローカル

```bash
npm install --save-dev arere-plugin-example
```

## プラグインの有効化

プラグインは `node_modules` から自動検出されます。設定ファイルで有効/無効を切り替えることができます：

### 設定ファイル (.arere/settings.json)

```json
{
  "plugins": {
    "arere-plugin-git": true,
    "arere-plugin-docker": true,
    "arere-plugin-example": {
      "enabled": true,
      "config": {
        "apiKey": "your-api-key"
      }
    }
  }
}
```

Settings画面からもプラグインの有効/無効を切り替えられます。

## プラグインで外部ライブラリを使用

プラグインは独自の依存関係を持つことができます。

### package.json

```json
{
  "name": "arere-plugin-with-deps",
  "dependencies": {
    "date-fns": "^2.30.0",
    "chalk": "^5.3.0"
  }
}
```

### アクションで使用

```typescript
// actions/date-formatter.ts
import { defineAction } from 'arere'
import { format } from 'date-fns'
import chalk from 'chalk'

export default defineAction({
  name: 'format-date',
  description: '現在時刻をフォーマット',
  async run({ tui }) {
    const now = new Date()
    const formatted = format(now, 'yyyy-MM-dd HH:mm:ss')
    tui.output.log(chalk.blue(`現在時刻: ${formatted}`))
  },
})
```

## 実用例

### Git操作プラグイン

```typescript
// arere-plugin-git/src/index.ts
import { definePlugin } from 'arere'

export default definePlugin({
  meta: {
    name: 'arere-plugin-git',
    version: '1.0.0',
    description: 'Git operations plugin',
  },
  actions: [
    './actions/git-status.ts',
    './actions/git-commit.ts',
    './actions/git-switch.ts',
    './actions/git-pull.ts',
    './actions/git-push.ts',
  ],
})
```

```typescript
// arere-plugin-git/actions/git-commit.ts
import { defineAction } from 'arere'

export default defineAction({
  name: 'git-commit',
  description: 'Git コミットを作成',
  category: 'git',
  async run({ tui, $ }) {
    // ステージされたファイルを表示
    const { stdout } = await $`git diff --cached --name-only`
    const files = stdout.split('\n').filter(Boolean)

    if (files.length === 0) {
      tui.output.warn('ステージされたファイルがありません')
      return
    }

    tui.output.log('変更されたファイル:')
    files.forEach(f => tui.output.log(`  - ${f}`))

    // コミットメッセージ入力
    const message = await tui.prompt.text('コミットメッセージ:', {
      validate: v => v.length > 0 || 'メッセージを入力してください',
    })

    // コミット実行
    await $`git commit -m ${message}`
    tui.output.success('✓ コミット完了')
  },
})
```

### Docker操作プラグイン

```typescript
// arere-plugin-docker/src/index.ts
import { definePlugin } from 'arere'

export default definePlugin({
  meta: {
    name: 'arere-plugin-docker',
    version: '1.0.0',
    description: 'Docker operations plugin',
  },
  actions: [
    './actions/docker-ps.ts',
    './actions/docker-compose-up.ts',
    './actions/docker-compose-down.ts',
    './actions/docker-logs.ts',
  ],
})
```

```typescript
// arere-plugin-docker/actions/docker-compose-up.ts
import { defineAction } from 'arere'

export default defineAction({
  name: 'docker-compose-up',
  description: 'Docker Compose を起動',
  category: 'docker',
  async run({ tui, $ }) {
    const detached = await tui.prompt.confirm(
      'バックグラウンドで起動しますか？',
      { defaultValue: true }
    )

    const flags = detached ? '-d' : ''
    await $`docker-compose up ${flags}`

    if (detached) {
      tui.output.success('✓ Docker Compose を起動しました')
    }
  },
})
```

## プラグインのテスト

### テストアクション

```typescript
// tests/plugin.test.ts
import { describe, it, expect } from 'vitest'
import plugin from '../src/index'

describe('Plugin', () => {
  it('should have valid metadata', () => {
    expect(plugin.meta.name).toBe('arere-plugin-example')
    expect(plugin.meta.version).toBeDefined()
  })

  it('should have actions', () => {
    expect(plugin.actions.length).toBeGreaterThan(0)
  })

  it('should have valid action paths', () => {
    for (const action of plugin.actions) {
      expect(action).toMatch(/^\.\/actions\/.*\.ts$/)
    }
  })
})
```

## プラグインの公開

### npmに公開

```bash
# ビルド
npm run build

# バージョンアップ
npm version patch  # or minor, major

# 公開
npm publish --access public
```

### README作成

```markdown
# arere-plugin-example

Example plugin for [arere](https://github.com/your-org/arere).

## Installation

\`\`\`bash
npm install -g arere-plugin-example
\`\`\`

## Usage

インストール後、arere を起動するとプラグインが自動検出されます。

Settings画面でプラグインの有効/無効を切り替えられます。

## Actions

- `example-action` - Example action

## License

MIT
```

## ベストプラクティス

### 1. 命名規則

- プラグイン名: `arere-plugin-{name}`
- アクション名: `{plugin-name}-{action}` (例: `git-commit`, `docker-up`)

### 2. カテゴリ分類

アクションに適切なカテゴリを設定：

```typescript
export default defineAction({
  name: 'git-commit',
  category: 'git',  // カテゴリで分類
  // ...
})
```

### 3. アイコン使用

視認性を高めるためにアイコンを使用：

```typescript
export default defineAction({
  // ...
})
```

### 4. エラーハンドリング

適切なエラーハンドリングを実装：

```typescript
export default defineAction({
  async run({ tui, $ }) {
    const result = await $`git status`
    if (result.exitCode !== 0) {
      tui.output.error('Git が利用できません')
      return
    }
  },
})
```

### 5. バリデーション

ユーザー入力を適切にバリデーション：

```typescript
const message = await tui.prompt.text('メッセージ:', {
  validate: (value) => {
    if (value.length === 0) return 'メッセージを入力してください'
    if (value.length > 100) return 'メッセージは100文字以内で入力してください'
    return true
  },
})
```

## 型定義

```typescript
interface ArerePlugin {
  /** プラグインのメタデータ */
  meta: PluginMeta
  /** アクションファイルパス（プラグインルートからの相対パス） */
  actions: string[]
  /** 翻訳ファイルディレクトリ（プラグインルートからの相対パス）*/
  locales?: string
}

interface PluginMeta {
  /** プラグイン名（arere-plugin-*形式） */
  name: string
  /** バージョン（セマンティックバージョニング） */
  version: string
  /** プラグインの説明 */
  description?: string
  /** 作成者 */
  author?: string
  /** i18n名前空間（省略時はプラグイン名） */
  i18nNamespace?: string
}

interface LoadedPlugin {
  /** プラグインのメタデータ */
  meta: PluginMeta
  /** プラグインディレクトリの絶対パス */
  path: string
  /** アクションファイルの絶対パス配列 */
  actionPaths: string[]
  /** 翻訳ディレクトリの絶対パス */
  localesPath?: string
  /** i18n名前空間 */
  i18nNamespace: string
}
```

### フィールド詳細

#### `ArerePlugin.locales`

プラグインの翻訳ファイルが格納されているディレクトリのパス（プラグインルートからの相対パス）。

```typescript
import { definePlugin } from 'arere'

export default definePlugin({
  meta: { /* ... */ },
  actions: ['actions/example.ts'],
  locales: 'locales',  // プラグインルート/locales/を指す
})
```

翻訳ファイル構造：
```
locales/
├── en/
│   └── translation.json
└── ja/
    └── translation.json
```

#### `PluginMeta.i18nNamespace`

プラグインの翻訳で使用する名前空間。省略した場合は `meta.name` が使用されます。

```typescript
// カスタム名前空間を使用
import { definePlugin } from 'arere'

export default definePlugin({
  meta: {
    name: 'arere-plugin-example',
    i18nNamespace: 'example',  // 翻訳で 'example' 名前空間を使用
  },
  locales: 'locales',
})
```

**アクション内での使用**:

プラグインの翻訳にアクセスする際は、**`plugin:` プレフィックス**を使用してください：

```typescript
// プラグインアクション内で
export default defineAction({
  name: 'example-action',
  description: ({ t }) => t('plugin:actions.example.description'),
  async run({ t }) {
    // ✓ 正しい
    const text = t('plugin:greeting')

    // ✗ 間違い（動作しません）
    const wrong = t('greeting', { ns: 'example' })
  }
})
```

**理由**: アクション内の `t()` 関数は、アクション自身の名前空間をデフォルトとして使用します。プラグインの翻訳にアクセスするには、`plugin:` プレフィックスで明示的に指定する必要があります。

## トラブルシューティング

### プラグインが認識されない

```bash
# プラグインがインストールされているか確認
npm list -g | grep arere-plugin

# 設定ファイルを確認
cat ~/.arere-config.json

# キャッシュをクリア
rm -rf ~/.cache/arere
```

### アクションが表示されない

- プラグインの `actions` 配列にアクションパスが含まれているか確認
- アクションファイルが存在するか確認
- `npm run build` でビルドされているか確認

### 依存関係エラー

プラグインの依存関係がインストールされているか確認：

```bash
cd node_modules/arere-plugin-example
npm install
```

## 参照

- [プラグイン開発ガイド](../guides/developing-plugins.md)
- [defineAction API](./defineAction.md)
- [アクション作成チュートリアル](../ja/guides/creating-actions.md)
