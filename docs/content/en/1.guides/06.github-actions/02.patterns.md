---
title: Common Patterns
description: Common patterns when using Arere with GitHub Actions
---

# Common Patterns

## Environment Variables

Access GitHub secrets as environment variables:

```typescript
export default defineAction({
  name: 'deploy',
  async run({ env, tui }) {
    const apiKey = env.API_KEY
    const deployUrl = env.DEPLOY_URL

    if (!apiKey) {
      throw new Error('API_KEY secret is required')
    }

    tui.output.info(`Deploying to ${deployUrl}`)
  }
})
```

```yaml
- uses: ./actions/arere-action
  with:
    action: deploy
  env:
    API_KEY: ${{ secrets.API_KEY }}
    DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
```

## Multi-Stage Pipeline

```typescript
// .arere/actions/ci-pipeline.ts
export default defineAction({
  name: 'ci-pipeline',
  description: 'Complete CI pipeline',
  async run({ $, tui }) {
    tui.output.section('Stage 1: Linting')
    await $`npm run lint`

    tui.output.section('Stage 2: Type Check')
    await $`npm run typecheck`

    tui.output.section('Stage 3: Testing')
    const testResult = await $`npm test`
    if (testResult.exitCode !== 0) {
      throw new Error('Tests failed')
    }

    tui.output.section('Stage 4: Build')
    await $`npm run build`

    tui.output.success('All stages succeeded!')
  }
})
```

## Error Handling and Rollback

```typescript
export default defineAction({
  name: 'deploy-with-rollback',
  async run({ $, tui }) {
    try {
      tui.output.section('Deploying')
      await $`npm run deploy`

      tui.output.section('Health Check')
      const health = await $`curl https://example.com/health`

      if (!health.stdout.includes('OK')) {
        throw new Error('Health check failed')
      }

      tui.output.success('Deployment succeeded')
    } catch (error) {
      tui.output.error('Deployment failed, rolling back')
      await $`npm run rollback`
      throw error
    }
  }
})
```

---

## Best Practices

### 1. Keep Actions Focused

Each action should do one thing well:

✅ Good:
- `test.ts` - Run tests
- `build.ts` - Build the project
- `deploy.ts` - Deploy to server

❌ Bad:
- `do-everything.ts` - Test, build, deploy, notify, etc.

### 2. Use Environment Variables for Configuration

```typescript
// ❌ Bad
const apiUrl = 'https://api.example.com'

// ✅ Good
const apiUrl = env.API_URL || 'https://api.example.com'
```

### 3. Provide Meaningful Output

```typescript
tui.output.section('Deploying')    // Major sections
tui.output.step(1, 'Building')     // Sequential steps
tui.output.info('...')             // Information
tui.output.success('Done!')        // Success
tui.output.error('Failed!')        // Error
```

### 4. Handle Errors Properly

```typescript
const result = await $`npm test`
if (result.exitCode !== 0) {
  tui.output.error('Tests failed')
  tui.output.code(result.stderr)
  throw new Error('Test suite failed')
}
```

### 5. Test Locally First

```bash
# Test the action
arere run deploy

# Simulate CI environment
CI=true arere run deploy
```

---

## CLI Arguments in CI

Pass arguments to actions for flexible CI workflows:

```typescript
// .arere/actions/deploy.ts
export default defineAction({
  name: 'deploy',
  description: 'Deploy to target environment',
  async run({ args, env, $, tui }) {
    const target = args[0] || env.DEPLOY_TARGET || 'staging'
    const dryRun = args.includes('--dry-run')

    if (dryRun) {
      tui.output.info(`[DRY RUN] Would deploy to ${target}`)
      return
    }

    await $`npm run deploy -- --env ${target}`
    tui.output.success(`Deployed to ${target}!`)
  }
})
```

```yaml
# .github/workflows/deploy.yml
jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm ci
      - run: npx arere run deploy staging

  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm ci
      - run: npx arere run deploy production
```

### Dynamic Arguments from GitHub Context

```yaml
- run: npx arere run release ${{ github.ref_name }}
```

```typescript
export default defineAction({
  name: 'release',
  async run({ args, $ }) {
    const version = args[0]  // e.g., 'v1.2.3' from git tag
    await $`npm publish --tag ${version}`
  }
})
```

---

## Next Steps

- [Advanced Usage](./advanced) - Artifacts, matrix builds
